<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>B-Rent ‚Äî –∞—Ä–µ–Ω–¥–∞ –≤–∏–¥–µ–æ—Ç–µ—Ö–Ω–∏–∫–∏</title>
<meta name="description" content="–ê—Ä–µ–Ω–¥–∞ –∫–∞–º–µ—Ä, –æ–ø—Ç–∏–∫–∏, —Å–≤–µ—Ç–∞, –∑–≤—É–∫–∞ –∏ –¥—Ä–æ–Ω–æ–≤. –ë—ã—Å—Ç—Ä–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–ø–ª–∞—Ç–∞ QR. –°–∫–∏–¥–∫–∏ –∑–∞ –¥–ª–∏—Ç–µ–ª—å–Ω—É—é –∞—Ä–µ–Ω–¥—É." />
<meta name="theme-color" content="#0b1116" />
<link rel="canonical" href="https://example.com/" />
<meta property="og:title" content="B-Rent ‚Äî –∞—Ä–µ–Ω–¥–∞ –≤–∏–¥–µ–æ—Ç–µ—Ö–Ω–∏–∫–∏" />
<meta property="og:description" content="–ö–∞–º–µ—Ä—ã, –æ–±—ä–µ–∫—Ç–∏–≤—ã, —Å–≤–µ—Ç, –∑–≤—É–∫ –∏ –¥—Ä–æ–Ω—ã. –£–¥–æ–±–Ω–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, QR-–æ–ø–ª–∞—Ç–∞, —Å–∫–∏–¥–∫–∏ –∑–∞ –¥–ª–∏—Ç–µ–ª—å–Ω—É—é –∞—Ä–µ–Ω–¥—É." />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://example.com/" />
<meta property="og:image" content="https://example.com/og-cover.jpg" />
<link rel="icon" href="/favicon.ico" />

<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "RentalStore",
  "name": "B-Rent ‚Äî –∞—Ä–µ–Ω–¥–∞ –≤–∏–¥–µ–æ—Ç–µ—Ö–Ω–∏–∫–∏",
  "image": "https://example.com/logo.png",
  "url": "https://example.com/",
  "telephone": "+7-700-000-00-00",
  "address": {
    "@type": "PostalAddress",
    "streetAddress": "—É–ª. –ê–±–∞—è 10",
    "addressLocality": "–ê–ª–º–∞—Ç—ã",
    "addressCountry": "KZ"
  },
  "openingHours": "Mo-Su 09:00-21:00",
  "priceRange": "$$"
}
</script>

<style>
:root{ --bg:#0b1116; --panel:#0f1720; --muted:#98a0ab; --accent:#ef4444; --good:#16a34a; --warn:#f59e0b; --ink:#e5e7eb; }
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:#fff;font-family:Inter,Arial,Helvetica,sans-serif}
.app{display:flex;min-height:100vh}
/* sidebar */
.sidebar{width:260px;background:var(--panel);padding:22px;display:flex;flex-direction:column;gap:12px;position:fixed;left:0;top:0;bottom:0}
.brand{font-size:20px;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:8px}
.brand img{width:24px;height:24px}
.cat-btn{background:transparent;border:1px solid #1f2a33;color:#fff;padding:10px;text-align:left;border-radius:8px;cursor:pointer}
.cat-btn.active{background:#111827;border-color:#24303a}
.content{margin-left:260px;flex:1;padding:22px}
/* header */
.header{display:flex;justify-content:space-between;align-items:center;gap:12px}
.input{background:#081019;border:1px solid #1f2937;padding:10px;border-radius:8px;color:#fff;width:100%}
.icon-cart{background:#111827;padding:8px 12px;border-radius:10px;cursor:pointer;border:1px solid #24303a}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:16px;margin-top:18px}
.card{background:#0f1720;border:1px solid #1f2a33;border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:10px}
.card img{width:100%;height:170px;object-fit:cover;border-radius:8px}
.card h3{margin:0;font-size:16px}
.card .meta{color:var(--muted);font-size:13px}
.badge{display:inline-block;padding:6px 10px;border-radius:999px;font-size:12px}
.badge.free{background:rgba(22,163,74,0.12);color:var(--good)}
.badge.busy{background:rgba(239,68,68,0.12);color:var(--accent)}
.badge.stock{background:#0c141c;border:1px solid #1f2a33;color:#d0d6dc;margin-left:6px}
.rating{font-size:14px;color:#ffd54f}
.btn{background:var(--accent);border:none;color:#fff;padding:10px;border-radius:8px;cursor:pointer;transition:opacity .15s ease}
.btn.ghost{background:transparent;border:1px solid #24303a}
.btn.small{padding:6px 10px;font-size:12px}
.btn.disabled,.btn:disabled{background:#6b7280;border-color:#4b5563;cursor:not-allowed;opacity:.6}
.add-btn{min-width:120px}
.side-panel{margin-top:16px;background:#0f1720;border-radius:12px;padding:12px;border:1px solid #1f2a33}
.cart-list{display:flex;flex-direction:column;gap:8px}
.cart-row{display:flex;gap:8px;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:#081018;border:1px solid #1b2630}
.small{font-size:13px;color:var(--muted)}
.footer{margin-top:26px;color:var(--muted);font-size:13px;text-align:center}
/* detail */
.detail{background:#0f1720;padding:18px;border-radius:12px;border:1px solid #1f2a33}
.gallery{display:flex;gap:8px}
.gallery img{width:100%;height:360px;object-fit:cover;border-radius:8px}
/* modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;padding:20px;z-index:90}
.modal-box{background:#071018;padding:18px;border-radius:12px;border:1px solid #18323f;max-width:540px;width:100%}
.hide{display:none}
/* toast */
.toast{position:fixed;right:16px;bottom:16px;background:#0b1a24;border:1px solid #143646;padding:10px 12px;border-radius:10px;z-index:99;min-width:220px}
/* filters */
.filters{display:flex;gap:8px;flex-wrap:wrap}
.filter-chip{border:1px solid #1f2a33;background:#0c141c;padding:6px 10px;border-radius:999px;cursor:pointer;font-size:12px}
.filter-chip.active{background:#111b26}
.controls{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
.range{display:flex;gap:8px;align-items:center}
.range input[type=number]{width:110px}
.sort{display:flex;gap:8px;align-items:center}
/* mobile toolbar */
.mobile-toolbar{position:fixed;left:0;right:0;bottom:0;background:#0f1720;border-top:1px solid #1f2a33;padding:10px;display:none;z-index:60}
.mobile-toolbar .bar{display:flex;justify-content:space-between;align-items:center}
.mobile-toolbar .bar .btn{padding:10px 14px}

/* ===== ADMIN ===== */
.admin-header{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
.tab{background:#0c141c;border:1px solid #1f2a33;color:#fff;padding:8px 12px;border-radius:999px;cursor:pointer}
.tab.active{background:#111b26}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border:1px solid #1f2a33;padding:8px;text-align:left}
.table th{background:#0c141c;color:var(--ink)}
.kpi{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin:12px 0}
.kpi .box{background:#0f1720;border:1px solid #1f2a33;border-radius:12px;padding:12px}
.tag{display:inline-block;background:#0c141c;border:1px solid #1f2a33;padding:2px 8px;border-radius:999px;font-size:12px}
.status-paid{color:var(--good)}
.status-pending{color:var(--warn)}
.status-issued{color:#60a5fa}
.status-returned{color:#c084fc}
.login-card{max-width:360px;margin:24px auto;background:#0f1720;border:1px solid #1f2a33;border-radius:12px;padding:16px}

/* responsive */
@media(max-width:900px){
  .sidebar{position:relative;width:100%;height:auto;display:flex;flex-direction:row;overflow:auto;padding:10px;gap:8px}
  .content{margin-left:0;padding:12px}
  .header{flex-direction:column;align-items:stretch}
  .gallery img{height:240px}
  .grid{grid-template-columns:repeat(auto-fill,minmax(170px,1fr))}
  .mobile-toolbar{display:block}
  body{padding-bottom:64px}
}
</style>

<!-- === Modern visual uplift (non-breaking) === -->
<style id="theme-modern">
:root{
  --gradient: radial-gradient(1200px 800px at 10% -10%,rgba(239,68,68,.16),transparent),
              radial-gradient(1000px 700px at 90% 10%,rgba(96,165,250,.12),transparent);
  --outline: 0 0 0 2px rgba(239,68,68,.35), 0 10px 20px rgba(0,0,0,.25);
}
/* Base background with soft gradients */
body{
  background-image: var(--gradient);
  background-attachment: fixed;
}
/* Panels: glass effect + subtle border */
.side-panel,.login-card,.detail,.modal-box{
  background: linear-gradient(180deg, rgba(15,23,32,.86), rgba(10,16,24,.86));
  border: 1px solid rgba(255,255,255,.06);
  box-shadow: 0 8px 24px rgba(0,0,0,.35);
  backdrop-filter: saturate(120%) blur(6px);
}
/* Sidebar polish */
.sidebar{
  background: linear-gradient(180deg, #0f1720 0%, #0b1116 100%);
  border-right: 1px solid rgba(255,255,255,.06);
}
.brand{letter-spacing:.2px}
.cat-btn{
  border-radius:12px;
  border:1px solid rgba(255,255,255,.06);
  transition: transform .18s ease, background .18s ease, border-color .18s ease;
}
.cat-btn:hover{background:#101826;border-color:#334454}
.cat-btn.active{
  background:linear-gradient(180deg,#111b26,#0d1621);
  border-color:#394b5a;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
}
/* Inputs: focus ring */
.input, select{
  transition: box-shadow .18s ease,border-color .18s ease,background .18s ease;
}
.input:focus, select:focus{
  outline: none;
  border-color:#365672;
  box-shadow: 0 0 0 3px rgba(59,130,246,.25);
  background:#0a1520;
}
/* Buttons */
.btn{
  border-radius:12px;
  font-weight:600;
  letter-spacing:.2px;
  transition: transform .16s ease, box-shadow .16s ease, opacity .16s ease, background .16s ease;
  box-shadow: 0 6px 16px rgba(239,68,68,.28);
}
.btn:hover{transform: translateY(-1px)}
.btn:active{transform: translateY(0)}
.btn.ghost{
  border-color: rgba(255,255,255,.10);
  box-shadow:none;
}
.btn.ghost:hover{background:#0e1823;border-color:#3a4b5a}
/* Cart icon */
.icon-cart{transition: transform .16s ease, box-shadow .16s ease}
.icon-cart:hover{transform: translateY(-1px); box-shadow:0 6px 16px rgba(0,0,0,.3)}

/* Cards */
.card{
  border:1px solid rgba(255,255,255,.06);
  background: linear-gradient(180deg, rgba(16,24,35,.92), rgba(12,18,27,.92));
  transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
}
.card:hover{
  transform: translateY(-4px);
  box-shadow: 0 14px 30px rgba(0,0,0,.45);
  border-color: rgba(255,255,255,.12);
}
.card img{filter: saturate(105%);}

/* Badges with gentle glow */
.badge{border:1px solid rgba(255,255,255,.08)}
.badge.free{box-shadow:0 0 0 2px rgba(22,163,74,.08) inset}
.badge.busy{box-shadow:0 0 0 2px rgba(239,68,68,.08) inset}
.badge.stock{background:rgba(12,20,28,.7)}

/* Gallery image rounded + shadow */
.gallery img{box-shadow:0 12px 28px rgba(0,0,0,.35)}

/* Toast: slide-in */
@keyframes slideIn{from{transform:translateY(12px);opacity:0}to{transform:translateY(0);opacity:1}}
.toast{animation: slideIn .25s ease}

/* Tables: zebra and rounded corners */
.table{border-radius:12px;overflow:hidden}
.table tr:nth-child(even){background:#0b131b}
.table th{border-bottom:1px solid rgba(255,255,255,.06)}

/* Footer fade */
.footer{opacity:.8}

/* Mobile toolbar polish */
.mobile-toolbar{backdrop-filter: blur(6px); background: rgba(15,23,32,.86)}

/* Focus-visible for keyboard users */
:focus-visible{outline: 2px solid rgba(59,130,246,.6); outline-offset:3px; border-radius:10px}

/* Motion safety */
@media (prefers-reduced-motion: reduce){
  *{transition:none !important; animation:none !important}
}
</style>
</head>
<body>
<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º">
    <div class="brand" id="brandGoHome"><img src="https://example.com/logo.png" alt="B-Rent"/> B-Rent</div>
    <div class="small">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
    <button class="cat-btn active" data-cat="all">–í—Å–µ</button>
    <button class="cat-btn" data-cat="camera">üì∑ –ö–∞–º–µ—Ä—ã</button>
    <button class="cat-btn" data-cat="lens">üéØ –û–±—ä–µ–∫—Ç–∏–≤—ã</button>
    <button class="cat-btn" data-cat="light">üí° –°–≤–µ—Ç</button>
    <button class="cat-btn" data-cat="drone">üöÅ –î—Ä–æ–Ω—ã</button>
    <button class="cat-btn" data-cat="sound">üéô –ó–≤—É–∫</button>
    <button class="cat-btn" data-cat="accessory">üéí –ê–∫—Å–µ—Å—Å—É–∞—Ä—ã</button>

    <div class="side-panel" aria-live="polite">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>–ö–æ—Ä–∑–∏–Ω–∞</strong></div>
        <div id="cartCountBadge" class="small">0</div>
      </div>
      <div style="height:10px"></div>
      <div class="cart-list" id="sidebarCartList"></div>
      <div style="height:10px"></div>
      <button class="btn" id="goToCartBtn">–ü–µ—Ä–µ–π—Ç–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É</button>
      <button class="btn ghost small" id="openAdmin">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</button>
    </div>
    <div style="flex:1"></div>
    <div class="small">¬© <span id="yearNow"></span> B-Rent</div>
  </aside>

  <!-- Content -->
  <main class="content">
    <div class="header">
      <div style="display:flex;align-items:center;gap:12px">
        <button id="navCatalog" class="btn ghost">–ö–∞—Ç–∞–ª–æ–≥</button>
        <button id="navCart" class="btn ghost">–ö–æ—Ä–∑–∏–Ω–∞</button>
        <button id="navAdmin" class="btn ghost">–ê–¥–º–∏–Ω</button>
      </div>
      <div>
        <h1 style="margin:0;cursor:pointer;font-size:20px" id="titleGoHome">–ö–∞—Ç–∞–ª–æ–≥ —Ç–µ—Ö–Ω–∏–∫–∏</h1>
        <div class="small" style="margin-top:6px">–í—ã–±–∏—Ä–∞–π—Ç–µ –¥–∞—Ç—ã, —Ñ–∏–ª—å—Ç—Ä—ã, –¥–æ–±–∞–≤–ª—è–π—Ç–µ –≤ –∫–æ—Ä–∑–∏–Ω—É ‚Äî –æ–ø–ª–∞—Ç–∏—Ç–µ –≤ –∫–æ–Ω—Ü–µ</div>
      </div>
      <div style="display:flex;gap:12px;align-items:center;width:100%;max-width:620px">
        <div class="search" style="flex:1">
          <input id="searchInput" class="input" placeholder="–ü–æ–∏—Å–∫: –Ω–∞–∑–≤–∞–Ω–∏–µ, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏" aria-label="–ü–æ–∏—Å–∫" />
        </div>
        <div class="icon-cart" id="topCartBtn" title="–û—Ç–∫—Ä—ã—Ç—å –∫–æ—Ä–∑–∏–Ω—É" aria-label="–û—Ç–∫—Ä—ã—Ç—å –∫–æ—Ä–∑–∏–Ω—É">üõí <span id="topCartCount">0</span></div>
      </div>
    </div>

    <!-- Quick filters and controls -->
    <div class="side-panel" style="margin-top:12px">
      <div class="controls">
        <div class="filters" aria-label="–ë—ã—Å—Ç—Ä—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã">
          <div class="filter-chip" data-filter="4k">4K/120fps</div>
          <div class="filter-chip" data-filter="8k">8K</div>
          <div class="filter-chip" data-filter="stabilization">–°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è</div>
          <div class="filter-chip" data-filter="drone">–î—Ä–æ–Ω—ã 40+ –º–∏–Ω</div>
        </div>
        <div class="range">
          <label class="small">–¶–µ–Ω–∞ –æ—Ç</label>
          <input id="minPrice" type="number" class="input" placeholder="–º–∏–Ω" />
          <label class="small">–¥–æ</label>
          <input id="maxPrice" type="number" class="input" placeholder="–º–∞–∫—Å" />
        </div>
        <div class="sort">
          <label class="small" for="sortBy">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
          <select id="sortBy" class="input" style="max-width:220px">
            <option value="popular">–ü–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏</option>
            <option value="priceAsc">–¶–µ–Ω–∞ ‚Üë</option>
            <option value="priceDesc">–¶–µ–Ω–∞ ‚Üì</option>
            <option value="new">–ù–æ–≤–∏–Ω–∫–∏</option>
          </select>
        </div>
        <button id="clearFilters" class="btn ghost small" title="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã">–°–±—Ä–æ—Å–∏—Ç—å</button>
      </div>
      <div class="small" style="margin-top:6px">–ó–∞–Ω—è—Ç—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –¥–∞—Ç–∞—Ö –ø–æ–¥—Å–≤–µ—á–∏–≤–∞—é—Ç—Å—è –∫—Ä–∞—Å–Ω–æ–π –º–µ—Ç–∫–æ–π.</div>
    </div>

    <!-- Date bar -->
    <div class="side-panel" style="margin-top:12px">
      <div style="display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap">
        <div>
          <label class="small">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
          <input id="globalStart" type="date" />
        </div>
        <div>
          <label class="small">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
          <input id="globalEnd" type="date" />
        </div>
        <div style="flex:1"></div>
        <button id="applyDatesBtn" class="btn ghost">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫ –∫–æ—Ä–∑–∏–Ω–µ</button>
        <button id="shareCartBtn" class="btn ghost" title="–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–æ—Ä–∑–∏–Ω—É">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –∫–æ—Ä–∑–∏–Ω–æ–π</button>
      </div>
      <div class="small" id="dateHint" style="margin-top:6px">–°–∫–∏–¥–∫–∏: 3+ –¥–Ω–µ–π ‚àí5%, 7+ –¥–Ω–µ–π ‚àí10%, 14+ –¥–Ω–µ–π ‚àí15% (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è).</div>
    </div>

    <!-- Catalog grid -->
    <section id="catalogSection" style="margin-top:18px">
      <div id="catalogGrid" class="grid"></div>
    </section>

    <!-- Product detail -->
    <section id="productDetail" class="hide" style="margin-top:18px"></section>

    <!-- Cart / Checkout -->
    <section id="cartSection" class="hide" style="margin-top:18px">
      <div style="display:flex;gap:16px;flex-wrap:wrap">
        <div style="flex:1;min-width:320px">
          <div class="side-panel">
            <h2 style="margin:0 0 10px">üõí –ö–æ—Ä–∑–∏–Ω–∞</h2>
            <div id="cartItemsList"></div>
            <div style="height:12px"></div>
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div class="small">–°—É–º–º–∞ –∑–∞ —Å—É—Ç–∫–∏</div>
              <div id="sumPerDay">0 —Ç–≥</div>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px">
              <div class="small">–î–Ω–µ–π –∞—Ä–µ–Ω–¥—ã</div>
              <div id="daysCount">1</div>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px">
              <div class="small">–°–∫–∏–¥–∫–∞ –∑–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</div>
              <div id="durationDiscount">0 —Ç–≥</div>
            </div>
            <div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap">
              <div>
                <label class="small">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
                <input id="startDate" type="date" />
              </div>
              <div>
                <label class="small">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                <input id="endDate" type="date" />
              </div>
            </div>
            <div style="height:12px"></div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn" id="checkoutBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–∫–∞–∑</button>
              <button class="btn ghost" id="chooseMoreBtn">–í—ã–±–∏—Ä–∞—Ç—å –µ—â—ë</button>
            </div>
            <div style="margin-top:12px;text-align:center" id="checkoutNotice" class="small muted"></div>
          </div>
        </div>

        <div style="width:430px;min-width:280px">
          <div class="side-panel">
            <h3 style="margin:0 0 10px">–î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞</h3>
            <input id="firstName" class="input" placeholder="–ò–º—è" autocomplete="given-name" />
            <div style="height:6px"></div>
            <input id="lastName" class="input" placeholder="–§–∞–º–∏–ª–∏—è" autocomplete="family-name" />
            <div style="height:6px"></div>
            <input id="phone" class="input" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω (+7 7xx xxx xx xx)" inputmode="tel" autocomplete="tel" />
            <div style="height:6px"></div>
            <input id="email" class="input" placeholder="Email (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" inputmode="email" autocomplete="email" />
            <div style="height:10px"></div>
            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
              <input id="promo" class="input" placeholder="–ü—Ä–æ–º–æ–∫–æ–¥ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" style="flex:1" />
              <button id="applyPromo" class="btn small">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            </div>
            <div id="promoNote" class="small" style="margin-top:6px"></div>
            <div style="height:10px"></div>
            <div style="font-weight:600">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ</div>
            <div id="grandTotal" style="font-size:20px;font-weight:700;margin-top:6px">0 —Ç–≥</div>
            <div class="small" id="grandTotalNote"></div>
            <div style="height:10px"></div>
            <button class="btn" id="openPayBtn">–û–ø–ª–∞—Ç–∏—Ç—å QR</button>
            <div style="height:8px"></div>
            <button class="btn ghost" id="confirmPaidBtn">–Ø –æ–ø–ª–∞—Ç–∏–ª (–ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å)</button>
          </div>
        </div>
      </div>
    </section>

    <!-- ===== ADMIN PANEL ===== -->
    <section id="adminSection" class="hide" style="margin-top:18px">
      <div class="side-panel">
        <div class="admin-header">
          <strong>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</strong>
          <span id="adminUserTag" class="tag">–ì–æ—Å—Ç—å</span>
          <button id="adminLogout" class="btn ghost small">–í—ã–π—Ç–∏</button>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
          <button class="tab active" data-tab="dashboard">Dashboard</button>
          <button class="tab" data-tab="inventory">–°–∫–ª–∞–¥</button>
          <button class="tab" data-tab="orders">–ó–∞–∫–∞–∑—ã</button>
          <button class="tab" data-tab="clients">–ö–ª–∏–µ–Ω—Ç—ã</button>
          <button class="tab" data-tab="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </div>
        <div id="adminContent"></div>
      </div>
    </section>

    <!-- ADMIN login -->
    <section id="adminLoginSection" class="hide" style="margin-top:18px">
      <div class="login-card">
        <h3 style="margin:0 0 10px">–í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h3>
        <input id="adminLogin" class="input" placeholder="–õ–æ–≥–∏–Ω" autocomplete="username" />
        <div style="height:6px"></div>
        <input id="adminPassword" class="input" placeholder="–ü–∞—Ä–æ–ª—å" type="password" autocomplete="current-password" />
        <div style="height:10px"></div>
        <button class="btn" id="adminDoLogin">–í–æ–π—Ç–∏</button>
        <div class="small" style="margin-top:8px">–ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è –¥–µ–º–æ: admin / admin123</div>
      </div>
    </section>

    <div class="footer">–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã ‚Äî –Ω–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –≤ WhatsApp</div>
  </main>
</div>

<!-- Mobile toolbar -->
<div class="mobile-toolbar">
  <div class="bar">
    <div class="small">–í –∫–æ—Ä–∑–∏–Ω–µ: <span id="mobCartCount">0</span> ‚Ä¢ –ò—Ç–æ–≥–æ: <span id="mobCartTotal">0 —Ç–≥</span></div>
    <button class="btn" id="mobOpenCart">–û—Ñ–æ—Ä–º–∏—Ç—å</button>
  </div>
</div>

<!-- QR Modal -->
<div id="qrModal" class="modal hide" role="dialog" aria-modal="true">
  <div class="modal-box">
    <h3>–û–ø–ª–∞—Ç–∞</h3>
    <p class="small">–°—É–º–º–∞: <span id="qrAmount">0 —Ç–≥</span></p>
    <div style="display:flex;justify-content:center;margin:12px 0">
      <img id="kaspiQr" src="" alt="QR" style="width:280px;height:280px;object-fit:contain;border-radius:8px;background:#071b20;padding:10px;border:1px solid #18323f">
    </div>
    <ol class="small" style="margin:0 0 12px 18px">
      <li>–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±–∞–Ω–∫–∞</li>
      <li>–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∏ –æ–ø–ª–∞—Ç–∏—Ç–µ.</li>
      <li>–ü–æ—Å–ª–µ –ø–µ—Ä–µ–≤–æ–¥–∞ –Ω–∞–∂–º–∏—Ç–µ ¬´–Ø –æ–ø–ª–∞—Ç–∏–ª¬ª.</li>
    </ol>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="paidBtnModal">–Ø –æ–ø–ª–∞—Ç–∏–ª</button>
      <button class="btn ghost" id="closeQrModal">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn ghost" id="copyPayLink">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast hide"></div>

<script>
/* ----------------- CONFIG ----------------- */
const APPS_SCRIPT_URL = ""; // –≤—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à /exec (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º ‚Äî –±—É–¥–µ—Ç –¥–µ–º–æ)
const ORDER_WEBHOOK_URL = APPS_SCRIPT_URL; // doPost —Ç–æ–≥–æ –∂–µ —Å–∫—Ä–∏–ø—Ç–∞
const CURRENCY = "—Ç–≥";
const QR_API_BASE = "https://api.qrserver.com/v1/create-qr-code/"; // –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞—Ä—Ç–∏–Ω–∫–∏ QR
const PAY_LINK_BASE = "b-rent://pay"; // –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π deeplink, –µ—Å–ª–∏ –µ—Å—Ç—å
// ===== ADMIN CONFIG =====
const ADMIN_LOGIN = 'admin';
const ADMIN_PASSWORD = 'admin123'; // –∑–∞–º–µ–Ω–∏—Ç–µ!
/* ------------------------------------------ */

/* ---------- State ---------- */
let state = { category:'all', q:'', cart:[], startDate:'', endDate:'', promo:null, sortBy:'popular', minPrice:null, maxPrice:null };
let ADMIN = { loggedIn: false, user: null, tab:'dashboard' };

/* ---------- Helpers ---------- */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const todayStr = ()=> new Date().toISOString().slice(0,10);
function fmt(n){ return Number(n||0).toLocaleString('ru-RU'); }
function t(n){ return `${fmt(n)} ${CURRENCY}` }
function parseMoney(str){ return Number(String(str).replace(/\s|[^\d.]/g,'')||0); }
function daysBetween(s,e){ if(!s||!e) return 1; const sd=new Date(s); const ed=new Date(e); const diff=Math.ceil((ed-sd)/(1000*60*60*24))+1; return Math.max(1,diff); }
function getCartQty(id){ return state.cart.find(c=>c.id===id)?.qty||0; }
function overlapWithBusy(p, s, e){ if(!p.busyUntil) return false; const busyUntil = new Date(p.busyUntil); if(!s||!e) return (p.status==='busy' && busyUntil >= new Date(new Date().setHours(0,0,0,0))); const start = new Date(s); return start <= busyUntil; }
function availableForUser(p){ const stock = Number(p.stock||1); if(overlapWithBusy(p, state.startDate, state.endDate)) return 0; const left = stock - getCartQty(p.id); return Math.max(0,left); }
function showToast(msg){ const el=$('#toast'); if(!el) return; el.textContent=msg; el.classList.remove('hide'); clearTimeout(showToast._t); showToast._t=setTimeout(()=>el.classList.add('hide'), 2400); }
function copyToClipboard(text){ navigator.clipboard?.writeText(text).then(()=>showToast('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞')).catch(()=>{ const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); showToast('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'); }); }
function safeText(sel, text){ const el=$(sel); if(el) el.textContent = text; }

/* ---------- Persistence ---------- */
const LS_KEY = 'brent_state_v6';
const LS_ORDERS_KEY = 'brent_orders_v1';
function loadState(){ try{ const raw=localStorage.getItem(LS_KEY); if(!raw) return; const s=JSON.parse(raw); state={...state, ...s}; }catch(e){} }
function saveState(){ const s={ cart:state.cart, startDate:state.startDate, endDate:state.endDate, promo:state.promo, q:state.q, category:state.category, sortBy:state.sortBy, minPrice:state.minPrice, maxPrice:state.maxPrice }; localStorage.setItem(LS_KEY, JSON.stringify(s)); }
function getOrders(){ try{ return JSON.parse(localStorage.getItem(LS_ORDERS_KEY)||'[]'); }catch(e){ return []; } }
function saveOrders(list){ localStorage.setItem(LS_ORDERS_KEY, JSON.stringify(list)); }

/* ---------- UTM + Referral ---------- */
function getUrlParams(){ return new URLSearchParams(location.search); }
function captureUtm(){ const p=getUrlParams(); const keys=['utm_source','utm_medium','utm_campaign','utm_term','utm_content','ref']; const out={}; keys.forEach(k=>{ const v=p.get(k); if(v) out[k]=v; }); if(Object.keys(out).length){ localStorage.setItem('brent_utm', JSON.stringify(out)); } }

/* ---------- Products (Sheets API with fallback) ---------- */
let PRODUCTS = [];
async function fetchProducts(){
  try {
    const DEMO = [
      { id:1, slug:"sony-a7s3", category:"camera", title:"Sony A7S III", price:20000, images:["https://picsum.photos/seed/sonya/800/600","https://picsum.photos/seed/sonya2/800/600"], description:"–ü–æ–ª–Ω–æ–∫–∞–¥—Ä–æ–≤–∞—è –∫–∞–º–µ—Ä–∞ –¥–ª—è –≤–∏–¥–µ–æ —Å –æ—Ç–ª–∏—á–Ω–æ–π —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –∏ 4K.", specs:{Sensor:"Full Frame", Video:"4K/120fps", Year:2021}, status:"free", busyUntil:"", rating:4.9, popular:95, stock:3 },
      { id:2, slug:"canon-r5", category:"camera", title:"Canon R5", price:18000, images:["https://picsum.photos/seed/canonr5/800/600"], description:"–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –∫–∞–º–µ—Ä–∞ Canon R5.", specs:{Sensor:"Full Frame", Video:"8K", Stabilization:"Yes", Year:2020}, status:"busy", busyUntil:"2025-08-25", rating:4.7, popular:90, stock:2 },
      { id:3, slug:"sigma-24-70", category:"lens", title:"Sigma 24-70mm f/2.8", price:8000, images:["https://picsum.photos/seed/sigma/800/600"], description:"–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∑—É–º.", specs:{Mount:"Sony E", Aperture:"f/2.8", Year:2019}, status:"free", busyUntil:"", rating:4.8, popular:80, stock:5 },
      { id:4, slug:"aputure-120d", category:"light", title:"Aputure 120D II", price:12000, images:["https://picsum.photos/seed/aputure/800/600"], description:"–ú–æ—â–Ω—ã–π LED –æ—Å–≤–µ—Ç–∏—Ç–µ–ª—å.", specs:{Power:"120W", Type:"LED", Year:2018}, status:"free", busyUntil:"", rating:4.6, popular:70, stock:4 },
      { id:5, slug:"dji-mavic-3", category:"drone", title:"DJI Mavic 3", price:25000, images:["https://picsum.photos/seed/dji/800/600"], description:"–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –¥—Ä–æ–Ω –¥–ª—è –∞—ç—Ä–æ—Å—ä–µ–º–∫–∏.", specs:{FlightTime:"45 min", Camera:"Hasselblad", Year:2022}, status:"free", busyUntil:"", rating:4.9, popular:92, stock:2 },
      { id:6, slug:"zoom-h6", category:"sound", title:"Zoom H6", price:4000, images:["https://picsum.photos/seed/zoomh6/800/600"], description:"–ú–Ω–æ–≥–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∫–æ—Ä–¥–µ—Ä.", specs:{Channels:"4-6", Battery:"AA", Year:2017}, status:"busy", busyUntil:"2025-08-23", rating:4.5, popular:65, stock:6 },
      { id:7, slug:"gimbal-ronin", category:"accessory", title:"Ronin-S Gimbal", price:10000, images:["https://picsum.photos/seed/ronin/800/600"], description:"–°—Ç–∞–±–∏–ª–∏–∑–∞—Ç–æ—Ä –¥–ª—è –∫–∞–º–µ—Ä.", specs:{Load:"3kg", Battery:"12h", Year:2019}, status:"free", busyUntil:"", rating:4.6, popular:85, stock:3 }
    ];

    if(!APPS_SCRIPT_URL){ PRODUCTS = DEMO; return; }
    const r = await fetch(APPS_SCRIPT_URL + "?action=products");
    if(!r.ok) throw new Error('HTTP '+r.status);
    const json = await r.json();
    PRODUCTS = (json && json.products && json.products.length) ? json.products : DEMO;
  } catch(e){ console.error(e); PRODUCTS = PRODUCTS?.length ? PRODUCTS : []; if(!PRODUCTS.length){ showToast('–ö–∞—Ç–∞–ª–æ–≥: –ø–æ–∫–∞–∑–∞–Ω—ã –¥–µ–º–æ-—Ç–æ–≤–∞—Ä—ã'); await new Promise(res=>setTimeout(res,0)); PRODUCTS = [ { id:1, slug:"demo", category:"camera", title:"Demo Cam", price:10000, images:["https://picsum.photos/seed/demo/800/600"], description:"Demo", specs:{Year:2020}, status:"free", busyUntil:"", rating:4.5, popular:50, stock:1 } ]; }
  }
}

/* ---------- Price bounds ---------- */
function setPriceBounds(){ if(!PRODUCTS.length) return; const prices=PRODUCTS.map(p=>p.price); const min=Math.min(...prices); const max=Math.max(...prices); if(!state.minPrice) state.minPrice=min; if(!state.maxPrice) state.maxPrice=max; const minEl=$('#minPrice'), maxEl=$('#maxPrice'); if(minEl) minEl.value=state.minPrice; if(maxEl) maxEl.value=state.maxPrice; }

/* ---------- Render helpers ---------- */
function stars(r){ const full=Math.floor(r); const half=(r-full)>=0.5; return '‚òÖ'.repeat(full) + (half?'¬Ω':'') + `<span class="small" style="margin-left:6px;color:var(--muted)">${(r||0).toFixed(1)}</span>`; }
function stockBadge(p){ const left = availableForUser(p); if(left<=0) return '<span class="badge busy">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</span>'; if(left===1) return '<span class="badge stock">–û—Å—Ç–∞–ª–∞—Å—å 1 —à—Ç.</span>'; return `<span class="badge stock">–í –Ω–∞–ª–∏—á–∏–∏: ${left} —à—Ç.</span>`; }
function sortProducts(list){ const s=state.sortBy; const arr=[...list]; if(s==='priceAsc') arr.sort((a,b)=>a.price-b.price); else if(s==='priceDesc') arr.sort((a,b)=>b.price-a.price); else if(s==='new') arr.sort((a,b)=>(b.specs?.Year||0)-(a.specs?.Year||0)); else arr.sort((a,b)=>(b.popular||0)-(a.popular||0)); return arr; }

/* ---------- Render Catalog ---------- */
function renderCatalog(){
  const grid=$('#catalogGrid'); if(!grid) return; grid.innerHTML='';
  const q = ($('#searchInput')?.value||'').trim().toLowerCase(); state.q=q;
  const activeFilters = $$('.filter-chip.active').map(ch=>ch.dataset.filter);
  const minP = Number($('#minPrice')?.value||0); const maxP = Number($('#maxPrice')?.value||Infinity); state.minPrice=minP; state.maxPrice=maxP;
  let filtered = PRODUCTS.filter(p=>{
    const catOk = state.category==='all' || p.category===state.category;
    const qOk = !q || p.title.toLowerCase().includes(q) || JSON.stringify(p.specs).toLowerCase().includes(q);
    const fOk = !activeFilters.length || activeFilters.every(f=>{
      if(f==='4k') return (p.specs?.Video||'').includes('4K');
      if(f==='8k') return (p.specs?.Video||'').includes('8K');
      if(f==='stabilization') return (p.specs?.Stabilization||'No')==='Yes';
      if(f==='drone') return (p.category==='drone' && String(p.specs?.FlightTime||'').match(/(4[0-9]|[5-9][0-9])/));
      return true;
    });
    const priceOk = p.price>=minP && p.price<=maxP;
    return catOk && qOk && fOk && priceOk;
  });
  filtered = sortProducts(filtered);

  const s = state.startDate, e = state.endDate;
  filtered.forEach(p=>{
    const noneLeft = availableForUser(p)===0;
    const busy = overlapWithBusy(p, s, e) || noneLeft;
    const availText = busy ? ('–ó–∞–Ω—è—Ç–æ'+ (p.busyUntil? ' –¥–æ '+ new Date(p.busyUntil).toLocaleDateString('ru-RU') : '')) : '–°–≤–æ–±–æ–¥–Ω–æ';
    const disabledAttrs = busy ? 'disabled' : '';
    const disabledClass = busy ? 'disabled' : '';
    const card=document.createElement('div'); card.className='card';
    card.innerHTML=`
      <img src="${(p.images&&p.images[0])||''}" alt="${p.title}" loading="lazy">
      <h3>${p.title}</h3>
      <div class="meta">${(p.category||'').toUpperCase()} ‚Ä¢ ${p.specs?.Year||''}</div>
      <div class="rating" aria-label="–†–µ–π—Ç–∏–Ω–≥">${stars(p.rating||4.7)}</div>
      <div class="price" style="font-weight:600">${t(p.price)} / —Å—É—Ç–∫–∏</div>
      <div>
        <span class="status badge ${busy? 'busy':'free'}">${availText}</span>
        ${stockBadge(p)}
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn add-btn ${disabledClass}" data-add="${p.id}" ${disabledAttrs}>–î–æ–±–∞–≤–∏—Ç—å</button>
        <button class="btn ghost" data-open="${p.slug||p.id}">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
      </div>`;
    grid.appendChild(card);
  });
  grid.querySelectorAll('[data-add]').forEach(btn=>btn.addEventListener('click',()=>{ if(btn.classList.contains('disabled')||btn.disabled) return; addToCart(Number(btn.getAttribute('data-add'))); btn.textContent='–î–æ–±–∞–≤–ª–µ–Ω–æ'; setTimeout(()=>btn.textContent='–î–æ–±–∞–≤–∏—Ç—å',700); }));
  grid.querySelectorAll('[data-open]').forEach(btn=>btn.addEventListener('click',()=>{ const slug=btn.getAttribute('data-open'); location.hash = 'product/'+slug; }));
  updateTopCounts(); saveState(); updateMobileBar();
}

/* ---------- Sidebar Cart ---------- */
function renderSidebarCart(){ const listEl=$('#sidebarCartList'); if(!listEl) return; listEl.innerHTML=''; if(state.cart.length===0){ const empty=document.createElement('div'); empty.className='small'; empty.textContent='–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞'; listEl.appendChild(empty); } else { state.cart.forEach(ci=>{ const el=document.createElement('div'); el.className='small'; el.textContent=`${ci.title} x${ci.qty} ‚Äî ${t(ci.price*ci.qty)}`; listEl.appendChild(el); }) } const cnt=state.cart.reduce((s,i)=>s+i.qty,0); safeText('#cartCountBadge', String(cnt)); safeText('#topCartCount', String(cnt)); safeText('#mobCartCount', String(cnt)); }
function updateTopCounts(){ renderSidebarCart(); }

/* ---------- Cart Section ---------- */
function durationDiscount(sumPerDay, d){ let rate = 0; if(d>=14) rate=0.15; else if(d>=7) rate=0.10; else if(d>=3) rate=0.05; const disc = Math.round(sumPerDay*d*rate); return {disc, rate}; }
function renderCartSection(){ const list=$('#cartItemsList'); if(!list) return; list.innerHTML=''; const d=daysBetween(state.startDate, state.endDate); safeText('#daysCount', String(d)); if(state.cart.length===0){ list.innerHTML='<div class="small">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>'; safeText('#sumPerDay', t(0)); safeText('#grandTotal', t(0)); safeText('#grandTotalNote',''); safeText('#durationDiscount', t(0)); updateMobileBar(); return; } let sumPerDay=0; state.cart.forEach(ci=>{ sumPerDay += ci.price*ci.qty; const p = PRODUCTS.find(x=>x.id===ci.id) || {}; const conflict = overlapWithBusy(p, state.startDate, state.endDate); const row=document.createElement('div'); row.className='cart-row'; row.innerHTML=`<div style="flex:1">${ci.title} ${conflict? '<span class="badge busy">–∫–æ–Ω—Ñ–ª–∏–∫—Ç –¥–∞—Ç</span>':''}<div class="small">${t(ci.price)} / —Å—É—Ç–∫–∏</div></div><div style="display:flex;gap:6px;align-items:center"><button class="btn ghost" data-dec="${ci.id}">‚àí</button><div style="min-width:28px;text-align:center">${ci.qty}</div><button class="btn ghost" data-inc="${ci.id}">+</button><button class="btn ghost" data-rem="${ci.id}">–£–¥–∞–ª–∏—Ç—å</button></div><div style="min-width:140px;text-align:right">${t(ci.price*ci.qty*d)}</div>`; list.appendChild(row); }); list.querySelectorAll('[data-dec]').forEach(b=>b.addEventListener('click',()=>{ changeQty(Number(b.getAttribute('data-dec')),-1); })); list.querySelectorAll('[data-inc]').forEach(b=>b.addEventListener('click',()=>{ changeQty(Number(b.getAttribute('data-inc')),+1); })); list.querySelectorAll('[data-rem]').forEach(b=>b.addEventListener('click',()=>{ removeFromCart(Number(b.getAttribute('data-rem'))); })); safeText('#sumPerDay', t(sumPerDay)); const dur=durationDiscount(sumPerDay, d); const totalRaw = sumPerDay*d - dur.disc; safeText('#durationDiscount', dur.disc ? `‚àí${t(dur.disc)}` : t(0)); const total = applyPromoIfAny(totalRaw); safeText('#grandTotal', t(total)); const promoText = state.promo? `–ü—Ä–æ–º–æ–∫–æ–¥: ${state.promo.code} (‚àí${state.promo.type==='percent'? state.promo.value+'%': t(state.promo.value)})` : ''; const durText = dur.rate ? `–°–∫–∏–¥–∫–∞ –∑–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ‚àí${Math.round(dur.rate*100)}%` : ''; safeText('#grandTotalNote', [durText, promoText].filter(Boolean).join(' ‚Ä¢ ')); saveState(); updateMobileBar(); }

/* ---------- Product Detail ---------- */
function productJsonLd(p){ return { "@context":"https://schema.org", "@type":"Product", "name": p.title, "image": p.images?.[0]||'', "description": p.description||'', "brand": {"@type":"Brand","name": (p.title.split(' ')[0]||'')}, "offers": {"@type":"Offer","priceCurrency":"KZT","price": String(p.price),"availability": availableForUser(p)>0? "https://schema.org/InStock" : "https://schema.org/OutOfStock"} }; }
function injectProductJsonLd(p){ const old=$('#product-jsonld'); if(old) old.remove(); const s=document.createElement('script'); s.type='application/ld+json'; s.id='product-jsonld'; s.textContent=JSON.stringify(productJsonLd(p)); document.head.appendChild(s); }
function renderProductDetailBySlug(slug){ const p=PRODUCTS.find(x=>x.slug===slug || String(x.id)===String(slug)); const detail=$('#productDetail'); if(!detail) return; if(!p){ detail.classList.remove('hide'); $('#catalogSection')?.classList.add('hide'); $('#cartSection')?.classList.add('hide'); detail.innerHTML='<div class="detail">–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω</div>'; return; } const busy = overlapWithBusy(p, state.startDate, state.endDate); injectProductJsonLd(p); detail.classList.remove('hide'); $('#catalogSection')?.classList.add('hide'); $('#cartSection')?.classList.add('hide'); const left = availableForUser(p); const isDisabled = busy || left===0; const availText = isDisabled? ('–ó–∞–Ω—è—Ç–æ'+ (p.busyUntil? ' –¥–æ '+ new Date(p.busyUntil).toLocaleDateString('ru-RU') : '')) : '–°–≤–æ–±–æ–¥–Ω–æ'; const leftText = left>0 ? (left===1? '–û—Å—Ç–∞–ª–∞—Å—å 1 —à—Ç.' : `–í –Ω–∞–ª–∏—á–∏–∏: ${left} —à—Ç.`) : '–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏'; detail.innerHTML=`<div class="detail"><a href="#catalog" class="small">&larr; –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∫–∞—Ç–∞–ª–æ–≥</a><div style="display:flex;gap:18px;align-items:flex-start;margin-top:8px;flex-wrap:wrap"><div style="flex:1;min-width:260px"><div class="gallery"><img src="${(p.images&&p.images[0])||''}" alt="${p.title}" /></div></div><div style="flex:1.2;min-width:300px"><h2 style="margin-top:0">${p.title}</h2><div class="rating">${stars(p.rating||4.7)}</div><p class="small" style="color:var(--muted)">${p.description||''}</p><div style="height:12px"></div><div><strong>–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:</strong></div><ul>${Object.entries(p.specs||{}).map(([k,v])=>`<li><strong>${k}:</strong> ${v}</li>`).join('')}</ul><div><span class="status badge ${isDisabled? 'busy':'free'}">${availText}</span><span class="badge stock">${leftText}</span></div><div style="height:8px"></div><div class="small" style="color:var(--muted)">–¶–µ–Ω–∞: ${t(p.price)} / —Å—É—Ç–∫–∏</div><div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap"><button class="btn add-btn ${isDisabled? 'disabled':''}" ${isDisabled? 'disabled':''} onclick="addToCart(${p.id})">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</button><a class="btn ghost" href="#catalog">–ù–∞–∑–∞–¥ –∫ –∫–∞—Ç–∞–ª–æ–≥—É</a></div></div></div></div>`; }

/* ---------- Cart logic ---------- */
function addToCart(productId){ const p = PRODUCTS.find(x=>x.id===productId); if(!p) return; const left = availableForUser(p); if(left<=0){ showToast('–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–∞—Ç—ã'); return; } if(overlapWithBusy(p, state.startDate, state.endDate)) { showToast('–≠—Ç–æ—Ç —Ç–æ–≤–∞—Ä –∑–∞–Ω—è—Ç –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–∞—Ç—ã'); return; } const idx = state.cart.findIndex(c=>c.id===p.id); if(idx>=0) state.cart[idx].qty = Math.min((p.stock||1), state.cart[idx].qty+1); else state.cart.push({ id:p.id, title:p.title, price:p.price, qty:1 }); renderSidebarCart(); renderCartSection(); saveState(); renderCatalog(); showToast('–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É'); }
function changeQty(id, delta){ const i=state.cart.findIndex(c=>c.id===id); if(i<0) return; const p = PRODUCTS.find(x=>x.id===id); if(delta>0){ const max = Number(p?.stock||1); if(state.cart[i].qty>=max){ showToast('–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –Ω–∞–ª–∏—á–∏—è'); return; } } state.cart[i].qty=Math.max(1,state.cart[i].qty+delta); renderSidebarCart(); renderCartSection(); saveState(); renderCatalog(); }
function removeFromCart(id){ state.cart = state.cart.filter(c=>c.id!==id); renderSidebarCart(); renderCartSection(); saveState(); renderCatalog(); showToast('–£–¥–∞–ª–µ–Ω–æ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã'); }

/* ---------- Promo ---------- */
const PROMO_DB = [ { code:'WELCOME10', type:'percent', value:10 }, { code:'RENT5000', type:'amount', value:5000 }, { code:'REF5', type:'percent', value:5 } ];
function applyPromoIfAny(total){ if(!state.promo) return total; if(state.promo.type==='percent') return Math.max(0, Math.round(total*(100-state.promo.value)/100)); if(state.promo.type==='amount') return Math.max(0, total - state.promo.value); return total; }

/* ---------- Validation & Payload ---------- */
function validateCheckout(){ if(state.cart.length===0){ alert('–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞'); return false; } const fn=$('#firstName')?.value.trim(); const ln=$('#lastName')?.value.trim(); const ph=$('#phone')?.value.trim(); const sd=$('#startDate')?.value; const ed=$('#endDate')?.value; if(!fn||!ln||!ph||!sd||!ed){ alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ: –ò–º—è, –§–∞–º–∏–ª–∏—é, –¢–µ–ª–µ—Ñ–æ–Ω –∏ –¥–∞—Ç—ã –∞—Ä–µ–Ω–¥—ã'); return false; } if(ed < sd){ alert('–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞'); return false; } const conflicts = state.cart.filter(ci=> overlapWithBusy(PRODUCTS.find(p=>p.id===ci.id)||{}, sd, ed)); if(conflicts.length){ alert('–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –∑–∞–Ω—è—Ç—ã: '+conflicts.map(c=>c.title).join(', ')); return false; } for(const ci of state.cart){ const p=PRODUCTS.find(x=>x.id===ci.id); if(!p) continue; if(ci.qty>Number(p.stock||1)) { alert(`${p.title}: –ø—Ä–µ–≤—ã—à–∞–µ—Ç –Ω–∞–ª–∏—á–∏–µ`); return false; } } state.startDate=sd; state.endDate=ed; saveState(); return true; }
function buildPayload(paymentStatus){ const d=daysBetween(state.startDate, state.endDate); const items=state.cart.map(i=>({ id:i.id, title:i.title, qty:i.qty, price:i.price, sum:i.price*i.qty*d })); const sumPerDay = state.cart.reduce((s,i)=>s+i.price*i.qty,0); const {disc, rate} = durationDiscount(sumPerDay, d); const totalRaw = items.reduce((s,i)=>s+i.sum,0) - disc; const total = applyPromoIfAny(totalRaw); const orderId='ORD-'+Date.now(); let utm={}; try{ utm=JSON.parse(localStorage.getItem('brent_utm')||'{}'); }catch(e){} return { orderId, firstName:$('#firstName')?.value.trim()||'', lastName:$('#lastName')?.value.trim()||'', phone:$('#phone')?.value.trim()||'', email:$('#email')?.value.trim()||'', startDate:state.startDate, endDate:state.endDate, days:d, items, total, discount:{ durationRate:rate, durationAmount: Math.round(sumPerDay*d*rate) }, promo:state.promo||null, sortBy:state.sortBy, filters:{ q:state.q, category:state.category, minPrice:state.minPrice, maxPrice:state.maxPrice }, utm, paymentStatus, createdAt: new Date().toISOString() }; }
async function postOrder(payload){ // –ª–æ–∫–∞–ª—å–Ω–æ –≤—Å–µ–≥–¥–∞ –∫–ª–∞–¥—ë–º –∑–∞–∫–∞–∑
  const orders = getOrders(); orders.push(payload); saveOrders(orders);
  if(!ORDER_WEBHOOK_URL){ console.warn('ORDER_WEBHOOK_URL –ø—É—Å—Ç ‚Äî –∏–º–∏—Ç–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'); return {ok:true, json:{mock:true}}; }
  try{ const r = await fetch(ORDER_WEBHOOK_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) }); if(!r.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'); const json = await r.json(); return {ok:true, json}; }catch(err){ console.error(err); alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑ ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ URL –∏ —Å–µ—Ç—å.'); return {ok:false}; }
}

/* ---------- Share cart ---------- */
function buildShareLink(){ const items = state.cart.map(i=>`${i.id}x${i.qty}`).join(','); const params = new URLSearchParams({ items, s:state.startDate||'', e:state.endDate||'', cat:state.category||'all', q:state.q||'', promo: state.promo?.code||'' }); const base = location.origin + location.pathname; return `${base}?${params.toString()}#cart`; }
function parseShareLink(){ const p=getUrlParams(); const items=p.get('items'); if(items){ const arr=String(items).split(',').filter(Boolean); const newCart=[]; arr.forEach(x=>{ const [id,qty]=x.split('x'); const prod=PRODUCTS.find(pr=>String(pr.id)===String(id)); if(prod) newCart.push({id:prod.id,title:prod.title,price:prod.price,qty:Math.max(1,Number(qty)||1)}); }); if(newCart.length){ state.cart=newCart; }} const s=p.get('s'); const e=p.get('e'); if(s) state.startDate=s; if(e) state.endDate=e; const cat=p.get('cat'); if(cat) state.category=cat; const q=p.get('q'); if(q) state.q=q; const promo=p.get('promo'); if(promo){ const found=PROMO_DB.find(x=>x.code.toUpperCase()===promo.toUpperCase()); if(found) state.promo={code:found.code,type:found.type,value:found.value}; } }

/* ---------- UI nav ---------- */
function showCatalog(){ $('#catalogSection')?.classList.remove('hide'); $('#productDetail')?.classList.add('hide'); $('#cartSection')?.classList.add('hide'); $('#adminSection')?.classList.add('hide'); $('#adminLoginSection')?.classList.add('hide'); safeText('#titleGoHome','–ö–∞—Ç–∞–ª–æ–≥ —Ç–µ—Ö–Ω–∏–∫–∏'); }
function showCart(){ $('#catalogSection')?.classList.add('hide'); $('#productDetail')?.classList.add('hide'); $('#adminSection')?.classList.add('hide'); $('#adminLoginSection')?.classList.add('hide'); $('#cartSection')?.classList.remove('hide'); renderCartSection(); renderSidebarCart(); safeText('#titleGoHome','–ö–æ—Ä–∑–∏–Ω–∞'); }
function showAdmin(){ $('#catalogSection')?.classList.add('hide'); $('#productDetail')?.classList.add('hide'); $('#cartSection')?.classList.add('hide'); if(ADMIN.loggedIn){ $('#adminSection')?.classList.remove('hide'); $('#adminLoginSection')?.classList.add('hide'); safeText('#adminUserTag', ADMIN.user||'–ê–¥–º–∏–Ω'); renderAdmin(); } else { $('#adminLoginSection')?.classList.remove('hide'); $('#adminSection')?.classList.add('hide'); } safeText('#titleGoHome','–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å'); }
function updateMobileBar(){ const totalEl=$('#grandTotal'); const mobEl=$('#mobCartTotal'); if(!totalEl||!mobEl) return; const total = parseMoney(totalEl.textContent); mobEl.textContent = t(total); }

/* ---------- ADMIN UI ---------- */
function renderAdmin(){ const root=$('#adminContent'); if(!root) return; const tab=ADMIN.tab; $$('.tab').forEach(b=>b.classList.toggle('active', b.dataset.tab===tab));
  if(tab==='dashboard') return adminDashboard(root);
  if(tab==='inventory') return adminInventory(root);
  if(tab==='orders') return adminOrders(root);
  if(tab==='clients') return adminClients(root);
  if(tab==='settings') return adminSettings(root);
}
function adminDashboard(root){ const orders=getOrders(); const revenue=orders.filter(o=>/–æ–ø–ª–∞—Ç/i.test(o.paymentStatus)).reduce((s,o)=>s+Number(o.total||0),0); const active=orders.filter(o=> new Date(o.endDate)>=new Date()).length; const popular=topPopular(orders,3).map(x=>`${x.title} (${x.count})`).join(', ')||'‚Äî'; root.innerHTML=`<div class="kpi"><div class="box"><div class="small">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div><div style="font-size:20px;font-weight:700">${fmt(orders.length)}</div></div><div class="box"><div class="small">–í—ã—Ä—É—á–∫–∞ (–æ–ø–ª–∞—á–µ–Ω–æ)</div><div style="font-size:20px;font-weight:700">${t(revenue)}</div></div><div class="box"><div class="small">–ê–∫—Ç–∏–≤–Ω—ã—Ö –∞—Ä–µ–Ω–¥</div><div style="font-size:20px;font-weight:700">${fmt(active)}</div></div><div class="box"><div class="small">–¢–æ–ø —Ç–æ–≤–∞—Ä—ã</div><div style="font-size:16px">${popular}</div></div></div>`; }
function topPopular(orders, n){ const map=new Map(); orders.forEach(o=>o.items.forEach(it=>{ const k=it.title; map.set(k,(map.get(k)||0)+it.qty); })); return [...map.entries()].sort((a,b)=>b[1]-a[1]).slice(0,n).map(([title,count])=>({title,count})); }
function adminInventory(root){ root.innerHTML=`<div style="display:flex;gap:8px;align-items:center;margin-bottom:8px"><button class="btn small" id="invSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button><span class="small">–†–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —è—á–µ–π–∫–∏ Stock/Busy</span></div><table class="table"><thead><tr><th>ID</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th>–¶–µ–Ω–∞</th><th>Stock</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ó–∞–Ω—è—Ç–æ –¥–æ</th></tr></thead><tbody id="invBody"></tbody></table>`; const tbody=$('#invBody'); PRODUCTS.forEach(p=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${p.id}</td><td>${p.title}</td><td>${p.category}</td><td>${t(p.price)}</td><td contenteditable data-field="stock" data-id="${p.id}">${p.stock||0}</td><td><select data-field="status" data-id="${p.id}"><option value="free" ${p.status==='free'?'selected':''}>free</option><option value="busy" ${p.status==='busy'?'selected':''}>busy</option></select></td><td contenteditable data-field="busyUntil" data-id="${p.id}">${p.busyUntil||''}</td>`; tbody.appendChild(tr); }); $('#invSave')?.addEventListener('click',()=>{ $$('[data-field][data-id]').forEach(el=>{ const id=Number(el.getAttribute('data-id')); const field=el.getAttribute('data-field'); const prod=PRODUCTS.find(p=>p.id===id); if(!prod) return; let val = (el.tagName==='SELECT') ? el.value : el.textContent.trim(); if(field==='stock') val = Number(val)||0; prod[field]=val; }); showToast('–°–∫–ª–∞–¥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω (–≤ –ø–∞–º—è—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã)'); renderCatalog(); }); }
function adminOrders(root){ const orders=getOrders().slice().reverse(); const rows = orders.map(o=>`<tr><td>${o.orderId}</td><td>${o.firstName} ${o.lastName}<div class="small">${o.phone}</div></td><td>${o.startDate} ‚Üí ${o.endDate}<div class="small">${o.days} –¥–Ω.</div></td><td>${o.items.map(i=>`${i.title} √ó${i.qty}`).join('<br>')}</td><td>${t(o.total)}</td><td><select data-ord="${o.orderId}" class="ord-status"><option ${/–æ–∂–∏–¥–∞–µ—Ç/i.test(o.paymentStatus)?'selected':''}>–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã</option><option ${/–æ–ø–ª–∞—á–µ–Ω/i.test(o.paymentStatus)?'selected':''}>–û–ø–ª–∞—á–µ–Ω (–∫–ª–∏–µ–Ω—Ç –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª)</option><option ${/–≤—ã–¥–∞–Ω/i.test(o.paymentStatus)?'selected':''}>–í—ã–¥–∞–Ω</option><option ${/–≤–æ–∑–≤—Ä–∞—â/i.test(o.paymentStatus)?'selected':''}>–í–æ–∑–≤—Ä–∞—â—ë–Ω</option></select></td></tr>`).join(''); root.innerHTML=`<div style="display:flex;gap:8px;align-items:center;margin-bottom:8px"><button id="expCsv" class="btn small">–≠–∫—Å–ø–æ—Ä—Ç CSV</button><input id="ordSearch" class="input" placeholder="–ü–æ–∏—Å–∫: –∏–º—è/—Ç–µ–ª–µ—Ñ–æ–Ω/—Ç–æ–≤–∞—Ä" style="max-width:280px" /></div><table class="table"><thead><tr><th>‚Ññ</th><th>–ö–ª–∏–µ–Ω—Ç</th><th>–î–∞—Ç—ã</th><th>–ü–æ–∑–∏—Ü–∏–∏</th><th>–°—É–º–º–∞</th><th>–°—Ç–∞—Ç—É—Å</th></tr></thead><tbody id="ordersBody">${rows||''}</tbody></table>`; $('#ordSearch')?.addEventListener('input',(e)=>{ const q=e.target.value.toLowerCase(); $$('#ordersBody tr').forEach(tr=>{ tr.style.display = tr.textContent.toLowerCase().includes(q)?'':'none'; }); }); $$('.ord-status').forEach(sel=> sel.addEventListener('change', ()=>{ const id=sel.getAttribute('data-ord'); const list=getOrders(); const idx=list.findIndex(o=>o.orderId===id); if(idx>=0){ list[idx].paymentStatus = sel.value; saveOrders(list); showToast('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—ë–Ω'); renderAdmin(); } })); $('#expCsv')?.addEventListener('click', ()=>{ const header=['orderId','firstName','lastName','phone','startDate','endDate','days','items','total','paymentStatus']; const lines=[header.join(',')]; orders.forEach(o=>{ const items=o.items.map(i=>`${i.title}√ó${i.qty}`).join(' | ').replaceAll(',',';'); lines.push([o.orderId,o.firstName,o.lastName,o.phone,o.startDate,o.endDate,o.days,`"${items}"`,o.total,o.paymentStatus].join(',')); }); const blob=new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='orders.csv'; a.click(); URL.revokeObjectURL(url); }); }
function adminClients(root){ const orders=getOrders(); const map=new Map(); orders.forEach(o=>{ const key=(o.phone||'')+'|'+(o.firstName||'')+'|'+(o.lastName||''); const prev=map.get(key)||{phone:o.phone, name:`${o.firstName||''} ${o.lastName||''}`.trim(), count:0, total:0}; prev.count += 1; prev.total += Number(o.total||0); map.set(key, prev); }); const rows=[...map.values()].sort((a,b)=>b.total-a.total).map(c=>`<tr><td>${c.name||'‚Äî'}<div class="small">${c.phone||''}</div></td><td>${c.count}</td><td>${t(c.total)}</td><td>${c.total>=500000?'<span class="tag">VIP</span>':''}</td></tr>`).join(''); root.innerHTML=`<table class="table"><thead><tr><th>–ö–ª–∏–µ–Ω—Ç</th><th>–ó–∞–∫–∞–∑–æ–≤</th><th>–°—É–º–º–∞</th><th>–ú–µ—Ç–∫–∏</th></tr></thead><tbody>${rows||''}</tbody></table>`; }
function adminSettings(root){ root.innerHTML=`<div class="small">URL –≤–µ–±—Ö—É–∫–∞ –∑–∞–∫–∞–∑–æ–≤:</div><input class="input" value="${ORDER_WEBHOOK_URL||''}" disabled /><div class="small" style="margin-top:10px">–í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω–∫—É –∑–∞—â–∏—â—ë–Ω –ª–æ–∫–∞–ª—å–Ω–æ. –î–ª—è –ø—Ä–æ–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ backend/JWT –∏ —Ä–æ–ª–∏.</div>`; }

/* ---------- Events ---------- */
$$('.cat-btn').forEach(b=> b.addEventListener('click', ()=>{ $$('.cat-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); state.category=b.dataset.cat; renderCatalog(); }));
$('#searchInput')?.addEventListener('input', ()=> renderCatalog());
$('#topCartBtn')?.addEventListener('click', ()=> location.hash='cart');
$('#goToCartBtn')?.addEventListener('click', ()=> location.hash='cart');
$('#chooseMoreBtn')?.addEventListener('click', ()=> { location.hash='catalog'; });
$('#sortBy')?.addEventListener('change', ()=>{ state.sortBy=$('#sortBy').value; saveState(); renderCatalog(); });
$('#minPrice')?.addEventListener('input', ()=> renderCatalog());
$('#maxPrice')?.addEventListener('input', ()=> renderCatalog());
$('#clearFilters')?.addEventListener('click', ()=>{ state.q=''; const si=$('#searchInput'); if(si) si.value=''; state.minPrice=null; state.maxPrice=null; setPriceBounds(); state.promo=null; $$('.filter-chip').forEach(ch=>ch.classList.remove('active')); state.category='all'; $$('.cat-btn').forEach(x=>x.classList.remove('active')); const allBtn=$$(`.cat-btn[data-cat="all"]`)[0]; if(allBtn) allBtn.classList.add('active'); renderCatalog(); showToast('–§–∏–ª—å—Ç—Ä—ã —Å–±—Ä–æ—à–µ–Ω—ã'); });

function setMinDates(){ const min=todayStr(); ['globalStart','startDate'].forEach(id=>{ const el=$('#'+id); if(!el) return; el.min=min; if(!el.value) el.value=min; }); const ge=$('#globalEnd'); const se=$('#endDate'); if(ge && $('#globalStart')){ if(!ge.value) ge.value=$('#globalStart').value; } if(se && $('#startDate')){ if(!se.value) se.value=$('#startDate').value; } }
function syncDatesToCart(){ const gs=$('#globalStart'); const ge=$('#globalEnd'); const sd=$('#startDate'); const ed=$('#endDate'); if(gs&&sd) sd.value=gs.value; if(ge&&ed) ed.value=ge.value; state.startDate=sd?.value||state.startDate; state.endDate=ed?.value||state.endDate; renderCartSection(); renderCatalog(); showToast('–î–∞—Ç—ã –ø—Ä–∏–º–µ–Ω–µ–Ω—ã'); }

$('#globalStart')?.addEventListener('change', ()=>{ const s=$('#globalStart').value; const e=$('#globalEnd'); if(e && e.value<s) e.value=s; state.startDate=s; renderCatalog(); saveState(); });
$('#globalEnd')?.addEventListener('change', ()=>{ const e=$('#globalEnd').value; const s=$('#globalStart'); if(s && e<s.value) s.value=e; state.endDate=e; renderCatalog(); saveState(); });
$('#applyDatesBtn')?.addEventListener('click', syncDatesToCart);
$('#startDate')?.addEventListener('change', ()=>{ state.startDate=$('#startDate').value; const e=$('#endDate'); if(e && e.value<state.startDate) e.value=state.startDate; renderCartSection(); renderCatalog(); saveState(); });
$('#endDate')?.addEventListener('change', ()=>{ state.endDate=$('#endDate').value; renderCartSection(); renderCatalog(); saveState(); });

$('#checkoutBtn')?.addEventListener('click', async ()=>{ if(!validateCheckout()) return; const payload = buildPayload('–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã'); const res = await postOrder(payload); if(res.ok){ const n=$('#checkoutNotice'); if(n) n.textContent='–ó–∞–∫–∞–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω. –ù–∞–∂–º–∏—Ç–µ ¬´–û–ø–ª–∞—Ç–∏—Ç—å QR¬ª –¥–ª—è –æ–ø–ª–∞—Ç—ã.'; showToast('–ó–∞–∫–∞–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω'); }});
$('#openPayBtn')?.addEventListener('click', ()=>{ if(!validateCheckout()) return; const amount = parseMoney($('#grandTotal')?.textContent||'0'); safeText('#qrAmount', t(amount)); const payloadText = `${PAY_LINK_BASE}?amount=${amount}&order=${encodeURIComponent(($('#firstName')?.value||'') + ' ' + ($('#lastName')?.value||''))}&id=${Date.now()}`; const qrUrl = `${QR_API_BASE}?size=280x280&data=${encodeURIComponent(payloadText)}`; const img=$('#kaspiQr'); if(img) img.src = qrUrl; $('#qrModal')?.classList.remove('hide'); });
$('#closeQrModal')?.addEventListener('click', ()=> $('#qrModal')?.classList.add('hide'));
$('#paidBtnModal')?.addEventListener('click', async ()=>{ if(!validateCheckout()) return; const payload = buildPayload('–û–ø–ª–∞—á–µ–Ω (–∫–ª–∏–µ–Ω—Ç –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª)'); const res = await postOrder(payload); if(res.ok){ $('#qrModal')?.classList.add('hide'); alert('–û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞ ‚Äî —Å–ø–∞—Å–∏–±–æ! –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏.'); state.cart=[]; renderSidebarCart(); renderCartSection(); saveState(); renderCatalog(); location.hash='catalog'; }});
$('#confirmPaidBtn')?.addEventListener('click', ()=>{ $('#qrModal')?.classList.remove('hide'); });
$('#copyPayLink')?.addEventListener('click', ()=>{ const amount = parseMoney($('#grandTotal')?.textContent||'0'); const link = `${PAY_LINK_BASE}?amount=${amount}&order=${encodeURIComponent(($('#firstName')?.value||'') + ' ' + ($('#lastName')?.value||''))}&id=${Date.now()}`; copyToClipboard(link); });

$('#applyPromo')?.addEventListener('click', ()=>{ const code = ($('#promo')?.value||'').trim().toUpperCase(); if(!code){ state.promo=null; const pn=$('#promoNote'); if(pn) pn.textContent=''; renderCartSection(); showToast('–ü—Ä–æ–º–æ–∫–æ–¥ –æ—á–∏—â–µ–Ω'); return; } const found = PROMO_DB.find(p=>p.code===code); if(!found){ const pn=$('#promoNote'); if(pn) pn.textContent='–ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω'; state.promo=null; renderCartSection(); return; } state.promo = {code:found.code, type:found.type, value:found.value}; const pn=$('#promoNote'); if(pn) pn.textContent='–ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω—ë–Ω'; renderCartSection(); showToast('–ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω—ë–Ω'); });
$$('.filter-chip').forEach(ch=> ch.addEventListener('click', ()=>{ ch.classList.toggle('active'); renderCatalog(); }))

$('#shareCartBtn')?.addEventListener('click', ()=>{ const link=buildShareLink(); copyToClipboard(link); });
$('#mobOpenCart')?.addEventListener('click', ()=> location.hash='cart');

// brand/nav handlers
const safeNav = (hash)=>{ location.hash = hash; };
$('#brandGoHome')?.addEventListener('click', ()=> safeNav('catalog'));
$('#titleGoHome')?.addEventListener('click', ()=> safeNav('catalog'));
$('#navCatalog')?.addEventListener('click', ()=> safeNav('catalog'));
$('#navCart')?.addEventListener('click', ()=> safeNav('cart'));
$('#openAdmin')?.addEventListener('click', ()=> safeNav('admin'));
$('#navAdmin')?.addEventListener('click', ()=> safeNav('admin'));

// ADMIN events
$('#adminDoLogin')?.addEventListener('click', ()=>{ const login=$('#adminLogin')?.value.trim()||''; const pass=$('#adminPassword')?.value||''; if(login===ADMIN_LOGIN && pass===ADMIN_PASSWORD){ ADMIN.loggedIn=true; ADMIN.user=login; localStorage.setItem('brent_admin', JSON.stringify({u:login, t:Date.now()})); showToast('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω'); showAdmin(); } else { alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å'); }});
$('#adminLogout')?.addEventListener('click', ()=>{ ADMIN.loggedIn=false; ADMIN.user=null; localStorage.removeItem('brent_admin'); showToast('–í—ã –≤—ã—à–ª–∏'); showAdmin(); });
$$('.tab').forEach(tab=> tab.addEventListener('click', ()=>{ ADMIN.tab=tab.dataset.tab; renderAdmin(); }));

// phone mask
$('#phone')?.addEventListener('input', (e)=>{ const v=e.target.value.replace(/\D/g,''); let out='+7 '; if(v.startsWith('7')){ const s=v.slice(1); out += `(${(s.slice(0,3)).padEnd(3,'_')}) ${(s.slice(3,6)||'___')} ${(s.slice(6,8)||'__')} ${(s.slice(8,10)||'__')}`; } else { out += `(${(v.slice(0,3)).padEnd(3,'_')}) ${(v.slice(3,6)||'___')} ${(v.slice(6,8)||'__')} ${(v.slice(8,10)||'__')}`; } e.target.value=out.trim(); });

/* ---------- Router ---------- */
function handleRoute(){ const h = location.hash.replace(/^#/, ''); const qp = getUrlParams(); const wantAdmin = h==='admin' || qp.get('admin')==='1'; if(!h || h==='catalog'){ showCatalog(); return; } if(h==='cart'){ showCart(); return; } if(h.startsWith('product/')){ const [,slug]=h.split('/'); renderProductDetailBySlug(slug); $('#catalogSection')?.classList.add('hide'); $('#cartSection')?.classList.add('hide'); return; } if(wantAdmin || h==='admin'){ showAdmin(); return; } showCatalog(); }
window.addEventListener('hashchange', handleRoute);

/* ---------- Init ---------- */
async function restoreUI(){ safeText('#yearNow', String(new Date().getFullYear())); captureUtm(); loadState(); setMinDates(); await fetchProducts(); setPriceBounds(); // admin session
  try{ const raw=localStorage.getItem('brent_admin'); if(raw){ const o=JSON.parse(raw); ADMIN.loggedIn=true; ADMIN.user=o.u; } }catch(e){}
  if(state.q) { const si=$('#searchInput'); if(si) si.value=state.q; }
  if(state.category){ const btn=$$(`.cat-btn[data-cat="${state.category}"]`)[0]; if(btn){ $$('.cat-btn').forEach(x=>x.classList.remove('active')); btn.classList.add('active'); } }
  if(state.sortBy && $('#sortBy')) $('#sortBy').value=state.sortBy;
  renderCatalog(); renderSidebarCart(); renderCartSection(); }

// --- Runtime tests (smoke) ---
function runDevTests(){ try{ state.cart=[]; const p=PRODUCTS[0]; const init=availableForUser(p); addToCart(p.id); const after=availableForUser(p); console.assert(after===Math.max(0,init-1),'Stock dec on add'); for(let i=0;i<20;i++) addToCart(p.id); const left=availableForUser(p); console.assert(left>=0,'Non-negative left'); console.log('%cDEV TESTS: OK','color:#16a34a'); }catch(e){ console.error('DEV TESTS FAILED', e); }}

if(document.readyState === 'loading'){
  document.addEventListener('DOMContentLoaded', () => { restoreUI().catch(err=>{ console.error(err); showToast('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏'); }); handleRoute(); runDevTests(); });
} else {
  restoreUI().catch(err=>{ console.error(err); showToast('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏'); }); handleRoute(); runDevTests();
}
</script>
</body>
</html>
